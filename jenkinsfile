pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = 'dockerizzz'
        IMAGE_TAG = "latest"
        DOCKER_CREDENTIALS_ID = 'dockerizzz-credentials'
        KUBECONFIG_CREDENTIALS_ID = 'kubeconfig'
        GIT_CREDENTIALS_ID = 'git-credentials'
        GIT_BRANCH = 'main'
    }

    stages {
        stage('Git Checkout') {
            steps {
                
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${env.GIT_BRANCH}"]],
                    userRemoteConfigs: [[
                        url: 'https://github.com/your-org/your-repo.git', 
                        credentialsId: "${GIT_CREDENTIALS_ID}"
                    ]]
                ])
            }
        }

      stage('Build & Push Images') {
            steps {
                script {
                    docker.withRegistry('', "${DOCKER_CREDENTIALS_ID}") {
                        def services = ['product-service', 'order-service', 'user-service', 'frontend']
                        for (svc in services) {
                            dir(svc) {
                                def image = docker.build("${DOCKER_REGISTRY}/${svc}:${IMAGE_TAG}", '.')
                                image.push()
                            }
                        }
                    }
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                withCredentials([file(credentialsId: "${KUBECONFIG_CREDENTIALS_ID}", variable: 'KUBECONFIG')]) {
                    sh '''
                        export KUBECONFIG=$KUBECONFIG
                        kubectl apply -f k8s/
                    '''
                }
            }
        }

        stage('Push to Git') {
            steps {
                withCredentials([usernamePassword(credentialsId: "${GIT_CREDENTIALS_ID}", usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
                    sh '''
                        git config user.email "ci-bot@example.com"
                        git config user.name "ci-bot"
                        git add .
                        git commit -m "Automated build and deploy [ci skip]" || echo "No changes to commit"
                        git push https://${GIT_USER}:${GIT_PASS}@$(git config --get remote.origin.url | sed -e 's#https://##') ${GIT_BRANCH}
                    '''
                }
            }
        }
    }
}